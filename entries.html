<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>journal Entries</title>
  <link rel="stylesheet" href="animations.css">
  <script src="animations.js"></script>
  <link rel="stylesheet" href="responsive.css">
 <link rel="icon" type="image/x-icon" href="assets/favicon.ico">

  <style>



   :root {
  --soft-blue: #cde6fe;         /* Calmness, trust */
  --soft-green: #b7fdb7;        /* Restoration, peace */
  --lavender: #E6E6FA;          /* Relaxation, sleep */
  --soft-pink: #ffd4ee;         /* Emotional safety */
  --white: #FFFFFF;             /* Clarity, openness */
  --earth-tone: #D8CAB8;        /* Grounding */
}
  
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Quicksand:wght@500;700&display=swap');

body {
  font-family: 'Nunito', sans-serif; /* for main readable text */
}
   

    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--soft-blue);
    }

    h1 {
      text-align: center;
    }

    .filters {
      text-align: center;
      margin-bottom: 20px;
    }

    .filters input, .filters button {
      padding: 10px;
      border-radius: 10px;
      font-size: 16px;
      margin: 5px;
    }

    .entry-box {
      background: #fff;
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 30px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.1);
    }

    .entry-box:hover{
       transform:  scale(1.02);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  animation: bounce 0.3s ease;
    }

    .single-entry {
      background: white;
      border: 2px dashed var(--earth-tone);
      border-radius: 12px;
      padding: 10px 15px;
      margin: 12px 0;
    }

    .entry-actions {
      margin-top: 10px;
      text-align: right;
    }

    .entry-actions button {
      padding: 6px 12px;
      border-radius: 8px;
      margin-left: 8px;
      cursor: pointer;
    }

    .entry-actions button:hover{
       transform:  scale(1.02);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  animation: bounce 0.3s ease;
    }

    .view-btn { background-color: var(--soft-green); }
    .edit-btn { background-color: var(--soft-pink); }
    .delete-btn { background-color: var(--lavender); }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      width: 80%;
      max-width: 700px;
      border-radius: 12px;
      overflow-y: auto;
      max-height: 80vh;
    }

    #modalViewer, #modalEditor {
      min-height: 200px;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
    }

    #modalEditor {
      background-color: #fffdf0;
    }

    #saveEditBtn {
      margin-top: 10px;
      padding: 10px 20px;
      border-radius: 10px;
      background: lightgreen;
      font-size: 16px;
    }

    #closeModalBtn {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }

    #back{
        position: absolute;
        top: 30px;
        left: 30px;
        width: 50px;
    }


  </style>
</head>
<body>

  <h1 class="anim-scroll">üìí Past Journal Entries</h1>

  <a href="journal.html" id="back-link">
  <img src="assets/back-arrow.png" id="back">
  </a>

  <div class="filters">
    <input type="date" id="filterDate">
    <input type="text" id="searchInput" placeholder="Enter keyword...">
    <!-- <button onclick="renderEntries()">üîç Search</button>-->
  </div>

  <div id="entriesContainer" class="anim-scroll"></div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span id="closeModalBtn" onclick="closeModal()">‚úñ</span>
      <h2 id="modalTitle">View Entry</h2>
      <div id="modalViewer"></div>
      <div id="modalEditor" contenteditable="true" style="display:none;"></div>
      <button id="saveEditBtn" onclick="saveEdit()" style="display:none;">üíæ Save</button>
    </div>
  </div>

  <script type="module">
import { protectPage } from "./authGuard.js";
protectPage();
</script>





  <script type="module">
import {
  db, auth, onAuthStateChanged,
  collection, query, where, orderBy, getDocs,
  doc, updateDoc, deleteDoc, serverTimestamp
} from "./firebase.js";

onAuthStateChanged(auth, (user) => {
  if (user) {
    console.log("User logged in:", user.uid);
    loadEntries(user);                 // <-- pass user
    filterDate.addEventListener("change", renderEntries);
    searchInput.addEventListener("input", renderEntries);
  } else {
    container.innerHTML = "<p style='text-align:center;'>Please log in to view your entries.</p>";
  }
});


/* ===== Sidebar Active Link ===== */
const currentPath = window.location.pathname.split("/").pop(); // e.g., "index.html"

document.querySelectorAll(".sidebar a").forEach(link => {
  const linkPath = link.getAttribute("href").split("/").pop();
  if (linkPath === currentPath || (linkPath === "index.html" && currentPath === "")) {
    link.classList.add("active");
  }
});


const container   = document.getElementById("entriesContainer");
const searchInput = document.getElementById("searchInput");
const filterDate  = document.getElementById("filterDate");

let entries = [];
let currentEdit = null;

// Fetch user‚Äôs entries from Firestore
async function loadEntries(user) {
  try {
    const q = query(
      collection(db, "journalEntries"),
      where("userId", "==", user.uid),
      orderBy("timestamp", "desc")
    );
    const snap = await getDocs(q);
    entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderEntries();
  } catch (err) {
    console.error("Error loading entries: ", err);
  }
}

// Render list into #entriesContainer
function renderEntries() {
  container.innerHTML = "";

  const text = (searchInput.value || "").toLowerCase();
  const dateFilter = (filterDate.value || "").trim();

  const filtered = entries.filter(e => {
    const okDate = !dateFilter || e.date === dateFilter;
    const okText = !text || (e.content || "").toLowerCase().includes(text);
    return okDate && okText;
  });

  if (filtered.length === 0) {
    container.innerHTML = "<p style='text-align:center;'>No entries found.</p>";
    return;
  }

  filtered.forEach(entry => {
    const box = document.createElement("div");
    box.className = "entry-box";
    box.innerHTML = `
      <h3>üìÖ ${entry.date} ${entry.time ? `‚Äî ‚è∞ ${entry.time}` : ""}</h3>
      <div class="single-entry">${entry.content || ""}</div>
      <div class="entry-actions">
        <button class="view-btn">View</button>
        <button class="edit-btn">Edit</button>
        <button class="delete-btn">Delete</button>
      </div>
    `;
    box.querySelector(".view-btn").onclick   = () => openModal(entry, false);
    box.querySelector(".edit-btn").onclick   = () => openModal(entry, true);
    box.querySelector(".delete-btn").onclick = () => deleteEntry(entry);
    container.appendChild(box);
  });
}

// Modal handlers
function openModal(entry, editable) {
  const viewer = document.getElementById("modalViewer");
  const editor = document.getElementById("modalEditor");
  const saveBtn = document.getElementById("saveEditBtn");

  document.getElementById("modalTitle").textContent = editable ? "Edit Entry" : "View Entry";
  viewer.style.display = editable ? "none" : "block";
  editor.style.display = editable ? "block" : "none";
  saveBtn.style.display = editable ? "inline-block" : "none";

  if (editable) {
    editor.innerHTML = entry.content || "";
    currentEdit = entry;
  } else {
    viewer.innerHTML = entry.content || "";
    currentEdit = null;
  }

  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}
window.closeModal = closeModal; // keep your existing close button working

async function saveEdit() {
  if (!currentEdit) return;
  const newHTML = document.getElementById("modalEditor").innerHTML;
  try {
    await updateDoc(doc(db, "journalEntries", currentEdit.id), {
      content: newHTML,
      updatedAt: serverTimestamp()
    });
    closeModal();
    const user = auth.currentUser;
    if (user) await loadEntries(user);
  } catch (err) {
    console.error("Error updating entry:", err);
  }
}
document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

async function deleteEntry(entry) {
  if (!entry?.id) return;
  if (!confirm("Are you sure you want to delete this entry?")) return;

  try {
    await deleteDoc(doc(db, "journalEntries", entry.id));
    closeModal();
    const user = auth.currentUser;
    if (user) await loadEntries(user);
  } catch (err) {
    console.error("Error deleting entry:", err);
  }
}

// Wait for login, then load
onAuthStateChanged(auth, (user) => {
  if (user) {
    loadEntries(user);
    filterDate.addEventListener("change", renderEntries);
    searchInput.addEventListener("input", renderEntries);
  } else {
    container.innerHTML = "<p style='text-align:center;'>Please log in to view your entries.</p>";
  }
});


</script>

</body>
</html>
